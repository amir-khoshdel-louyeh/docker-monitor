<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Docker Monitor Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <header>Docker Monitor Dashboard</header>
    <div class="container">
        <h2>Container Controls</h2>

        <div class="global-controls">
            <button onclick="sendGlobalAction('stop')">Stop All</button>
            <button onclick="sendGlobalAction('pause')">Pause All</button>
            <button onclick="sendGlobalAction('unpause')">Unpause All</button>
            <button onclick="sendGlobalAction('restart')">Restart All</button>
            <button onclick="sendGlobalAction('remove')">Remove All</button>

        </div>

        <h2>Container Status</h2>
        <table border="1" cellspacing="0" cellpadding="10" style="margin: auto;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>CPU (%)</th>
                    <th>RAM (%)</th>
                    <th>Controls</th>
                </tr>
            </thead>
            <tbody id="container-body"></tbody>
        </table>

        <h3>Logs</h3>
        <div id="logbox" class="log-box"></div>

        <div class="terminal-wrapper">
            <h3>Terminal</h3>
            <div id="terminal" class="terminal" onclick="this.querySelector('input:not([disabled])').focus()">
                <!-- Terminal content will be dynamically generated here -->
            </div>
        </div>
    </div>

    <script>
    // ---------- Shell-like features for command input ----------
    const commandInput = document.getElementById('command-input');
    const terminal = document.getElementById('terminal');
    const commandHistory = [];
    let historyIndex = -1;

    function attachInputListener(inputElement) {
        inputElement.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Prevent form submission
            runCommand(inputElement);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (historyIndex > 0) {
                historyIndex--;
            }
            if (commandHistory[historyIndex]) {
                inputElement.value = commandHistory[historyIndex];
            }
        } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (historyIndex < commandHistory.length - 1) {
                historyIndex++;
                commandInput.value = commandHistory[historyIndex];
            } else {
                // Go to a blank line at the end of history
                historyIndex = commandHistory.length;
                inputElement.value = '';
            }
        }
    });
    }

    // ---------- Container Controls ----------
    function sendAction(action, name) {
        fetch('/control', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action, name: name })
        }).then(r => r.json()).then(data => console.log(data.status)); // Log status instead of alert
    }

    function sendGlobalAction(action) {
        fetch('/control_all', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action })
        }).then(r => r.json()).then(data => console.log(data.status)); // Log status instead of alert
    }

    function createNewInputLine() {
        const line = document.createElement('div');
        line.className = 'terminal-input-line';
        line.innerHTML = `
            <span class="prompt">&gt;</span>
            <input type="text" class="command-input" autofocus>
        `;
        terminal.appendChild(line);
        const new_input = line.querySelector('input');
        attachInputListener(new_input);
        new_input.focus();
        terminal.scrollTop = terminal.scrollHeight;
    }

    function runCommand(input) {
        const command = input.value;
        if (!command) {
            return;
        }

        // Add to history and reset index
        commandHistory.push(command);
        historyIndex = commandHistory.length;
        
        // Make current input line static
        const parentLine = input.parentNode;
        parentLine.removeChild(input);
        parentLine.innerHTML += `<span class="command-text">${command}</span>`;

        // Handle 'clear' command locally in the browser
        if (command.toLowerCase() === 'clear') {
            terminal.innerHTML = '';
            createNewInputLine();
            return;
        }

        fetch('/run_command', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command: command })
        }).then(response => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            function read() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        updateContainerStats(); // Refresh table after command finishes
                        createNewInputLine(); // Add a new input line for the next command
                        return;
                    }
                    const outputLine = document.createElement('div');
                    outputLine.className = 'output-line';
                    outputLine.innerHTML = decoder.decode(value, { stream: true }).replace(/\n/g, '<br>');
                    terminal.appendChild(outputLine);
                    terminal.scrollTop = terminal.scrollHeight; // Auto-scroll
                    read(); // Continue reading
                });
            }
            read();
        });
    }

    // ---------- Logs ----------
    function fetchLogs() {
        fetch('/logs')
            .then(r => r.json())
            .then(logs => {
                const logbox = document.getElementById('logbox');
                logbox.innerHTML = logs.join('<br>');
                logbox.scrollTop = logbox.scrollHeight;
            });
    }

    // ---------- Streaming Stats ----------
    function initStream() {
        const tbody = document.getElementById("container-body");
        const eventSource = new EventSource("/stream");

        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            let row = document.getElementById("row-" + data.name);
            let id_cell_class = "id-" + data.id;

            if (!row) {
                row = document.createElement("tr");
                row.id = "row-" + data.name;
                row.innerHTML = `
                    <td class="${id_cell_class}">${data.id}</td>
                    <td class="name">${data.name}</td>
                    <td class="status">${data.status}</td>
                    <td class="cpu">${data.cpu}</td>
                    <td class="ram">${data.ram}</td>
                    <td>
                        <button onclick="sendAction('stop', '${data.name}')">Stop</button>
                        <button onclick="sendAction('pause', '${data.name}')">Pause</button>
                        <button onclick="sendAction('unpause', '${data.name}')">Unpause</button>
                        <button onclick="sendAction('restart', '${data.name}')">Restart</button>
                        <button onclick="sendAction('remove', '${data.name}')">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            } else {
                row.querySelector("." + id_cell_class).textContent = data.id;
                row.querySelector(".status").textContent = data.status;
                row.querySelector(".cpu").textContent = data.cpu;
                row.querySelector(".ram").textContent = data.ram;
            }
        };
    }

    // ---------- Full table refresh (every 60 seconds to catch removed containers) ----------
    function updateContainerStats() {
        fetch('/container_stats')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('container-body');
                tbody.innerHTML = ''; // clear everything
                data.forEach(container => {
                    const row = document.createElement('tr');
                    row.id = "row-" + container.name;
                    row.innerHTML = `
                        <td class="id-${container.id}">${container.id}</td>
                        <td class="name">${container.name}</td>
                        <td class="status">${container.status}</td>
                        <td class="cpu">${container.cpu}</td>
                        <td class="ram">${container.ram}</td>
                        <td>
                        <button onclick="sendAction('stop', '${container.name}')">stop</button>
                            <button onclick="sendAction('pause', '${container.name}')">Pause</button>
                            <button onclick="sendAction('unpause', '${container.name}')">Unpause</button>
                            <button onclick="sendAction('restart', '${container.name}')">Restart</button>
                            <button onclick="sendAction('remove', '${container.name}')">Remove</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
    }

    // ---------- Init ----------
    createNewInputLine();                    // Create the initial terminal prompt
    fetchLogs();
    setInterval(fetchLogs, 10000);           // refresh logs every 10s
    initStream();                            // live updates via SSE
    updateContainerStats();                  // initial table load
    setInterval(updateContainerStats, 60000); // refresh full table every 60s
</script>

</body>
</html>
